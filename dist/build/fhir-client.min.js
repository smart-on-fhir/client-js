// @ts-nocheck
"use strict";var FHIR=(()=>{var pt=Object.defineProperty;var I=(e,t)=>()=>(e&&(t=e(e=0)),t);var ae=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),gt=(e,t)=>{for(var r in t)pt(e,r,{get:t[r],enumerable:!0})};var X,ve=I(()=>{"use strict";X=class extends Error{constructor(t){super(`${t.status} ${t.statusText}
URL: ${t.url}`),this.name="HttpError",this.response=t,this.statusCode=t.status,this.status=t.status,this.statusText=t.statusText}async parse(){if(!this.response.bodyUsed)try{let t=this.response.headers.get("content-type")||"text/plain";if(t.match(/\bjson\b/i)){let r=await this.response.json();r.error?(this.message+=`
`+r.error,r.error_description&&(this.message+=": "+r.error_description)):this.message+=`

`+JSON.stringify(r,null,4)}else if(t.match(/^text\//i)){let r=await this.response.text();r&&(this.message+=`

`+r)}}catch{}return this}toJSON(){return{name:this.name,statusCode:this.statusCode,status:this.status,statusText:this.statusText,message:this.message}}}});var Te,Ee,_e,_,ee=I(()=>{"use strict";Te=["Account","AdverseEvent","AllergyIntolerance","Appointment","AppointmentResponse","AuditEvent","Basic","BodySite","BodyStructure","CarePlan","CareTeam","ChargeItem","Claim","ClaimResponse","ClinicalImpression","Communication","CommunicationRequest","Composition","Condition","Consent","Coverage","CoverageEligibilityRequest","CoverageEligibilityResponse","DetectedIssue","DeviceRequest","DeviceUseRequest","DeviceUseStatement","DiagnosticOrder","DiagnosticReport","DocumentManifest","DocumentReference","EligibilityRequest","Encounter","EnrollmentRequest","EpisodeOfCare","ExplanationOfBenefit","FamilyMemberHistory","Flag","Goal","Group","ImagingManifest","ImagingObjectSelection","ImagingStudy","Immunization","ImmunizationEvaluation","ImmunizationRecommendation","Invoice","List","MeasureReport","Media","MedicationAdministration","MedicationDispense","MedicationOrder","MedicationRequest","MedicationStatement","MolecularSequence","NutritionOrder","Observation","Order","Patient","Person","Procedure","ProcedureRequest","Provenance","QuestionnaireResponse","ReferralRequest","RelatedPerson","RequestGroup","ResearchSubject","RiskAssessment","Schedule","ServiceRequest","Specimen","SupplyDelivery","SupplyRequest","VisionPrescription"],Ee={"0.4.0":2,"0.5.0":2,"1.0.0":2,"1.0.1":2,"1.0.2":2,"1.1.0":3,"1.4.0":3,"1.6.0":3,"1.8.0":3,"3.0.0":3,"3.0.1":3,"3.3.0":4,"3.5.0":4,"4.0.0":4,"4.0.1":4},_e=["patient","subject","requester","member","actor","beneficiary"],_="SMART_KEY"});var qe=ae((mr,Oe)=>{var J=1e3,N=J*60,K=N*60,j=K*24,mt=j*7,yt=j*365.25;Oe.exports=function(e,t){t=t||{};var r=typeof e;if(r==="string"&&e.length>0)return wt(e);if(r==="number"&&isFinite(e))return t.long?bt(e):Rt(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))};function wt(e){if(e=String(e),!(e.length>100)){var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(t){var r=parseFloat(t[1]),i=(t[2]||"ms").toLowerCase();switch(i){case"years":case"year":case"yrs":case"yr":case"y":return r*yt;case"weeks":case"week":case"w":return r*mt;case"days":case"day":case"d":return r*j;case"hours":case"hour":case"hrs":case"hr":case"h":return r*K;case"minutes":case"minute":case"mins":case"min":case"m":return r*N;case"seconds":case"second":case"secs":case"sec":case"s":return r*J;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return r;default:return}}}}function Rt(e){var t=Math.abs(e);return t>=j?Math.round(e/j)+"d":t>=K?Math.round(e/K)+"h":t>=N?Math.round(e/N)+"m":t>=J?Math.round(e/J)+"s":e+"ms"}function bt(e){var t=Math.abs(e);return t>=j?ce(e,t,j,"day"):t>=K?ce(e,t,K,"hour"):t>=N?ce(e,t,N,"minute"):t>=J?ce(e,t,J,"second"):e+" ms"}function ce(e,t,r,i){var n=t>=r*1.5;return Math.round(e/r)+" "+i+(n?"s":"")}});var Me=ae((yr,Be)=>{function Ct(e){r.debug=r,r.default=r,r.coerce=d,r.disable=o,r.enable=n,r.enabled=c,r.humanize=qe(),r.destroy=l,Object.keys(e).forEach(u=>{r[u]=e[u]}),r.names=[],r.skips=[],r.formatters={};function t(u){let a=0;for(let f=0;f<u.length;f++)a=(a<<5)-a+u.charCodeAt(f),a|=0;return r.colors[Math.abs(a)%r.colors.length]}r.selectColor=t;function r(u){let a,f=null,g,m;function h(...w){if(!h.enabled)return;let y=h,q=Number(new Date),$=q-(a||q);y.diff=$,y.prev=a,y.curr=q,a=q,w[0]=r.coerce(w[0]),typeof w[0]!="string"&&w.unshift("%O");let U=0;w[0]=w[0].replace(/%([a-zA-Z%])/g,(Q,F)=>{if(Q==="%%")return"%";U++;let E=r.formatters[F];if(typeof E=="function"){let L=w[U];Q=E.call(y,L),w.splice(U,1),U--}return Q}),r.formatArgs.call(y,w),(y.log||r.log).apply(y,w)}return h.namespace=u,h.useColors=r.useColors(),h.color=r.selectColor(u),h.extend=i,h.destroy=r.destroy,Object.defineProperty(h,"enabled",{enumerable:!0,configurable:!1,get:()=>f!==null?f:(g!==r.namespaces&&(g=r.namespaces,m=r.enabled(u)),m),set:w=>{f=w}}),typeof r.init=="function"&&r.init(h),h}function i(u,a){let f=r(this.namespace+(typeof a>"u"?":":a)+u);return f.log=this.log,f}function n(u){r.save(u),r.namespaces=u,r.names=[],r.skips=[];let a=(typeof u=="string"?u:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(let f of a)f[0]==="-"?r.skips.push(f.slice(1)):r.names.push(f)}function s(u,a){let f=0,g=0,m=-1,h=0;for(;f<u.length;)if(g<a.length&&(a[g]===u[f]||a[g]==="*"))a[g]==="*"?(m=g,h=f,g++):(f++,g++);else if(m!==-1)g=m+1,h++,f=h;else return!1;for(;g<a.length&&a[g]==="*";)g++;return g===a.length}function o(){let u=[...r.names,...r.skips.map(a=>"-"+a)].join(",");return r.enable(""),u}function c(u){for(let a of r.skips)if(s(u,a))return!1;for(let a of r.names)if(s(u,a))return!0;return!1}function d(u){return u instanceof Error?u.stack||u.message:u}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return r.enable(r.load()),r}Be.exports=Ct});var ze=ae((x,ue)=>{x.formatArgs=St;x.save=Ft;x.load=Pt;x.useColors=xt;x.storage=kt();x.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();x.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function xt(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let e;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(e=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(e[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function St(e){if(e[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+e[0]+(this.useColors?"%c ":" ")+"+"+ue.exports.humanize(this.diff),!this.useColors)return;let t="color: "+this.color;e.splice(1,0,t,"color: inherit");let r=0,i=0;e[0].replace(/%[a-zA-Z%]/g,n=>{n!=="%%"&&(r++,n==="%c"&&(i=r))}),e.splice(i,0,t)}x.log=console.debug||console.log||(()=>{});function Ft(e){try{e?x.storage.setItem("debug",e):x.storage.removeItem("debug")}catch{}}function Pt(){let e;try{e=x.storage.getItem("debug")||x.storage.getItem("DEBUG")}catch{}return!e&&typeof process<"u"&&"env"in process&&(e=process.env.DEBUG),e}function kt(){try{return localStorage}catch{}}ue.exports=Me()(x);var{formatters:At}=ue.exports;At.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}});function ye({value:e,code:t}){if(typeof e!="number")throw new Error("Found a non-numerical unit: "+e+" "+t)}async function It(e){if(!e.ok){let t=new X(e);throw await t.parse(),t}return e}function vt(e){return e.text().then(t=>t.length?JSON.parse(t):"")}function we(e){if(!e)return e;if(Array.isArray(e))return e.map(r=>r&&typeof r=="object"?we(r):r);let t={};return Object.keys(e).forEach(r=>{let i=r.toLowerCase(),n=e[r];t[i]=n&&typeof n=="object"?we(n):n}),t}async function O(e,t={}){let{includeResponse:r,...i}=t;return fetch(e,{mode:"cors",...i,headers:{accept:"application/json",...we(i.headers)}}).then(It).then(n=>{let s=n.headers.get("content-type")+"";return s.match(/\bjson\b/i)?vt(n).then(o=>({res:n,body:o})):s.match(/^text\//i)?n.text().then(o=>({res:n,body:o})):{res:n}}).then(({res:n,body:s})=>{if(!s&&n.status==201){let o=n.headers.get("location");if(o)return O(o,{...i,method:"GET",body:null,includeResponse:r})}return r?{body:s,response:n}:s===void 0?n:s})}function Re(e,t,r=!1){return r||!le[e]?(le[e]=O(e,t),le[e]):Promise.resolve(le[e])}function W(e="/",t){let r=String(e).replace(/\/*$/,"/")+"metadata";return Re(r,t).catch(i=>{throw new Error(`Failed to fetch the conformance statement from "${r}". ${i}`)})}function k(e,t=""){if(t=t.trim(),!t)return e;let r=t.split("."),i=e;for(;i&&r.length;){let n=r.shift();if(!n&&Array.isArray(i))return i.map(s=>k(s,r.join(".")));i=i[n]}return i}function fe(e,t,r,i=!1){return t.trim().split(".").reduce((n,s,o,c)=>{if(n&&o===c.length-1)n[s]=r;else return n&&n[s]===void 0&&i&&(n[s]=c[o+1].match(/^[0-9]+$/)?[]:{}),n?n[s]:void 0},e),e}function M(e){return Array.isArray(e)?e:[e]}function te(e,t){return e.match(/^http/)||e.match(/^urn/)?e:String(t||"").replace(/\/+$/,"")+"/"+e.replace(/^\/+/,"")}function je(e=8,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"){let r=[],i=t.length;for(;e--;)r.push(t.charAt(Math.floor(Math.random()*i)));return r.join("")}function be(e,t){let r=e.split(".")[1];return r?JSON.parse(t.atob(r)):null}function De(e=120,t){return Math.floor(+(t||new Date)/1e3+e)}function he(e,t){let r=Math.floor(Date.now()/1e3);if(e.expires_in)return r+e.expires_in;if(e.access_token){let i=be(e.access_token,t);if(i&&i.exp)return i.exp}return r+300}function Ce(e,t){let r={};function i(n,s){n&&Array.isArray(n.coding)&&n.coding.forEach(({code:o})=>{o&&(r[o]=r[o]||[],r[o].push(s))})}return M(e).forEach(n=>{n.resourceType==="Observation"&&n[t]&&(Array.isArray(n[t])?n[t].forEach(s=>i(s,n)):i(n[t],n))}),r}function $e(e,t){let r=Ce(e,t);return(...i)=>i.filter(n=>n+""in r).reduce((n,s)=>n.concat(r[s+""]),[])}function Le(e,t){let i=(k(e,"rest.0.resource")||[]).find(s=>s.type===t);if(!i)throw new Error(`Resource "${t}" is not supported by this FHIR server`);if(!Array.isArray(i.searchParam))throw new Error(`No search parameters supported for "${t}" on this FHIR server`);if(t=="Patient"&&i.searchParam.find(s=>s.name=="_id"))return"_id";let n=_e.find(s=>i.searchParam.find(o=>o.name==s));if(!n)throw new Error("I don't know what param to use for "+t);return n}async function Je(e,t=800,r=720){if(typeof e=="function"&&(e=await e()),e&&typeof e=="object")return e;if(typeof e!="string")return S("Invalid target type '%s'. Failing back to '_self'.",typeof e),self;if(e=="_self")return self;if(e=="_parent")return parent;if(e=="_top")return top||self;if(e=="_blank"){let n,s=null;try{if(s=window.open("","SMARTAuthPopup"),!s)throw new Error("Perhaps window.open was blocked")}catch(o){n=o}return s||(S("Cannot open window. Failing back to '_self'. %s",n),self)}if(e=="popup"){let n,s=null;try{if(s=window.open("","SMARTAuthPopup",["height="+r,"width="+t,"menubar=0","resizable=1","status=0","top="+(screen.height-r)/2,"left="+(screen.width-t)/2].join(",")),!s)throw new Error("Perhaps the popup window was blocked")}catch(o){n=o}return s||(S("Cannot open window. Failing back to '_self'. %s",n),self)}let i=frames[e];return i||(S("Unknown target '%s'. Failing back to '_self'.",e),self)}function p(e,t){if(!e)throw new Error(t)}function Ne(e){p(Array.isArray(e),"The JSON patch must be an array"),p(e.length>0,"The JSON patch array should not be empty"),e.forEach(t=>{p(["add","replace","test","move","copy","remove"].indexOf(t.op)>-1,'Each patch operation must have an "op" property which must be one of: "add", "replace", "test", "move", "copy", "remove"'),p(t.path&&typeof t.path,`Invalid "${t.op}" operation. Missing "path" property`),t.op=="add"||t.op=="replace"||t.op=="test"?(p("value"in t,`Invalid "${t.op}" operation. Missing "value" property`),p(Object.keys(t).length==3,`Invalid "${t.op}" operation. Contains unknown properties`)):t.op=="move"||t.op=="copy"?(p(typeof t.from=="string",`Invalid "${t.op}" operation. Requires a string "from" property`),p(Object.keys(t).length==3,`Invalid "${t.op}" operation. Contains unknown properties`)):p(Object.keys(t).length==2,`Invalid "${t.op}" operation. Contains unknown properties`)})}var Ut,S,le,He,de=I(()=>{"use strict";ve();ee();Ut=ze(),S=Ut("FHIR"),le={},He={cm({code:e,value:t}){if(ye({code:e,value:t}),e=="cm")return t;if(e=="m")return t*100;if(e=="in"||e=="[in_us]"||e=="[in_i]")return t*2.54;if(e=="ft"||e=="[ft_us]")return t*30.48;throw new Error("Unrecognized length unit: "+e)},kg({code:e,value:t}){if(ye({code:e,value:t}),e=="kg")return t;if(e=="g")return t/1e3;if(e.match(/lb/))return t/2.20462;if(e.match(/oz/))return t/35.274;throw new Error("Unrecognized weight unit: "+e)},any(e){return ye(e),e.value}}});var v,Ke=I(()=>{"use strict";v={expired:"Session expired! Please re-launch the app",noScopeForId:"Trying to get the ID of the selected %s. Please add 'launch' or 'launch/%s' to the requested scopes and try again.",noIfNoAuth:"You are trying to get %s but the app is not authorized yet.",noFreeContext:"Please don't use open fhir servers if you need to access launch context items like the %S."}});var Tt,D,xe=I(()=>{"use strict";ee();de();Tt=S.extend("FhirClient"),D=class{constructor(t){p(t&&typeof t=="string"&&t.match(/https?:\/\/.+/),'A "fhirBaseUrl" string parameter is required and must begin with "http(s)"'),this.fhirBaseUrl=t}async create(t,r){return this.fhirRequest(t.resourceType,{...r,method:"POST",body:JSON.stringify(t),headers:{"content-type":"application/json",...(r||{}).headers}})}async update(t,r){return this.fhirRequest(`${t.resourceType}/${t.id}`,{...r,method:"PUT",body:JSON.stringify(t),headers:{"content-type":"application/json",...(r||{}).headers}})}async delete(t,r={}){return this.fhirRequest(t,{...r,method:"DELETE"})}async patch(t,r,i={}){return Ne(r),this.fhirRequest(t,{...i,method:"PATCH",body:JSON.stringify(r),headers:{prefer:"return=presentation","content-type":"application/json-patch+json; charset=UTF-8",...i.headers}})}async resolveRef(t,r,i,n,s={}){let o=k(t,r);if(o){let c=Array.isArray(o);return Promise.all(M(o).filter(Boolean).map((d,l)=>{let u=d.reference;if(u)return this.fhirRequest(u,{...s,includeResponse:!1,cacheMap:n}).then(a=>{i&&(c?r.indexOf("..")>-1?fe(t,`${r.replace("..",`.${l}.`)}`,a):fe(t,`${r}.${l}`,a):fe(t,r,a))}).catch(a=>{if(a?.status===404)console.warn(`Missing reference ${u}. ${a}`);else throw a})}))}}async resolveReferences(t,r,i={}){await this.fetchReferences(t,r,!0,{},i)}async fetchReferences(t,r,i,n={},s={}){if(t.resourceType=="Bundle"){for(let l of t.entry||[])l.resource&&await this.fetchReferences(l.resource,r,i,n,s);return n}let o=r.map(l=>String(l).trim()).filter(Boolean);if(o=o.reduce((l,u)=>(l.includes(u)?Tt('Duplicated reference path "%s"',u):l.push(u),l),[]),!o.length)return Promise.resolve(n);let c={};o.forEach(l=>{let u=l.split(".").length;c[u]||(c[u]=[]),c[u].push(l)});let d=Promise.resolve();return Object.keys(c).sort().forEach(l=>{let u=c[l];d=d.then(()=>Promise.all(u.map(a=>this.resolveRef(t,a,i,n,s))))}),await d,n}async getReferences(t,r,i={}){let n=await this.fetchReferences(t,r,!1,{},i),s={};for(let o in n)s[o]=await n[o];return s}async*resources(t,r){let i=0;for await(let n of this.pages(t,r))for(let s of n.entry||[]){if(r?.limit&&++i>r.limit)return;yield s.resource}}async*pages(t,r){let{limit:i,...n}=r||{},s=d=>this.fhirRequest(d,n),o=typeof t=="string"||t instanceof URL?await s(t):t,c=0;for(;o&&o.resourceType==="Bundle"&&(!i||++c<=i)&&(yield o,!n?.signal?.aborted);){let d=(o.link??[]).find(l=>l.relation==="next"&&typeof l.url=="string");if(!d)break;o=await s(d.url)}}async fhirRequest(t,r={}){p(r,"fhirRequest requires a uri as first argument");let i=t+"",n=te(i,this.fhirBaseUrl),{cacheMap:s}=r;return s?(i in s||(s[i]=O(n,r).then(o=>(s[i]=o,o)).catch(o=>{throw delete s[i],o})),s[i]):O(n,r)}async getFhirVersion(){return W(this.fhirBaseUrl).then(t=>t.fhirVersion)}async getFhirRelease(){return this.getFhirVersion().then(t=>Ee[t]??0)}}});async function Et(e,t){let r=te("/",t.state.serverUrl);async function i(n){let s=n.pathname.split("/").pop();p(s,`Invalid url "${n}"`),p(Te.indexOf(s)>-1,`Cannot filter "${s}" resources by patient`);let o=await W(t.state.serverUrl),c=Le(o,s);return n.searchParams.set(c,t.patient.id),n.href}return typeof e=="string"||e instanceof URL?{url:await i(new URL(e+"",r))}:(e.url=await i(new URL(e.url+"",r)),e)}var A,z,Se=I(()=>{"use strict";de();Ke();ee();xe();A=S.extend("client");z=class extends D{constructor(r,i){let n=typeof i=="string"?{serverUrl:i}:i;p(n.serverUrl&&n.serverUrl.match(/https?:\/\/.+/),'A "serverUrl" option is required and must begin with "http(s)"');super(n.serverUrl);this.units=He;this.state=n,this.environment=r,this._refreshTask=null;let s=this;this.patient={get id(){return s.getPatientId()},read:o=>{let c=this.patient.id;return c?this.request({...o,url:`Patient/${c}`}):Promise.reject(new Error("Patient is not available"))},request:(o,c={})=>this.patient.id?(async()=>{let d=await Et(o,this);return this.request(d,c)})():Promise.reject(new Error("Patient is not available"))},this.encounter={get id(){return s.getEncounterId()},read:o=>{let c=this.encounter.id;return c?this.request({...o,url:`Encounter/${c}`}):Promise.reject(new Error("Encounter is not available"))}},this.user={get fhirUser(){return s.getFhirUser()},get id(){return s.getUserId()},get resourceType(){return s.getUserType()},read:o=>{let c=this.user.fhirUser;return c?this.request({...o,url:c}):Promise.reject(new Error("User is not available"))}},this.connect(r.fhir)}connect(r){if(typeof r=="function"){let i={baseUrl:this.state.serverUrl.replace(/\/$/,"")},n=this.getState("tokenResponse.access_token");if(n)i.auth={token:n};else{let{username:o,password:c}=this.state;o&&c&&(i.auth={user:o,pass:c})}this.api=r(i);let s=this.getState("tokenResponse.patient");s&&(this.patient.api=r({...i,patient:s}))}return this}getPatientId(){let r=this.state.tokenResponse;return r?r.patient?r.patient:((this.state.scope||"").match(/\blaunch(\/patient)?\b/)?A("The ID of the selected patient is not available. Please check if your server supports that."):A(v.noScopeForId,"patient","patient"),null):(this.state.authorizeUri?A(v.noIfNoAuth,"the ID of the selected patient"):A(v.noFreeContext,"selected patient"),null)}getEncounterId(){let r=this.state.tokenResponse;return r?r.encounter?r.encounter:((this.state.scope||"").match(/\blaunch(\/encounter)?\b/)?A("The ID of the selected encounter is not available. Please check if your server supports that, and that the selected patient has any recorded encounters."):A(v.noScopeForId,"encounter","encounter"),null):(this.state.authorizeUri?A(v.noIfNoAuth,"the ID of the selected encounter"):A(v.noFreeContext,"selected encounter"),null)}getIdToken(){let r=this.state.tokenResponse;if(r){let i=r.id_token,n=this.state.scope||"";if(!i){let s=n.match(/\bopenid\b/),o=n.match(/\bprofile\b/),c=n.match(/\bfhirUser\b/);return A(!s||!(c||o)?"You are trying to get the id_token but you are not using the right scopes. Please add 'openid' and 'fhirUser' or 'profile' to the scopes you are requesting.":"The id_token is not available. Please check if your server supports that."),null}return be(i,this.environment)}return this.state.authorizeUri?A(v.noIfNoAuth,"the id_token"):A(v.noFreeContext,"id_token"),null}getFhirUser(){let r=this.getIdToken();return r?r.fhirUser?r.fhirUser.split("/").slice(-2).join("/"):r.profile:null}getUserId(){let r=this.getFhirUser();return r?r.split("/")[1]:null}getUserType(){let r=this.getFhirUser();return r?r.split("/")[0]:null}getAuthorizationHeader(){let r=this.getState("tokenResponse.access_token");if(r)return"Bearer "+r;let{username:i,password:n}=this.state;return i&&n?"Basic "+this.environment.btoa(i+":"+n):null}async _clearState(){let r=this.environment.getStorage(),i=await r.get(_);i&&await r.unset(i),await r.unset(_),this.state.tokenResponse={}}async request(r,i={},n={}){let s=S.extend("client:request");p(r,"request requires an url or request options as argument");let o;typeof r=="string"||r instanceof URL?(o=String(r),r={}):o=String(r.url),o=te(o,this.state.serverUrl);let c={graph:i.graph!==!1,flat:!!i.flat,pageLimit:i.pageLimit??1,resolveReferences:M(i.resolveReferences||[]),useRefreshToken:i.useRefreshToken!==!1,onPage:typeof i.onPage=="function"?i.onPage:void 0},d=r.signal||void 0;c.useRefreshToken&&await this.refreshIfNeeded({signal:d});let l=this.getAuthorizationHeader();l&&(r.headers={...r.headers,authorization:l}),s("%s, options: %O, fhirOptions: %O",o,r,c);let u;return super.fhirRequest(o,r).then(a=>r.includeResponse?(u=a.response,a.body):a).catch(async a=>{throw a.status==401?this.getState("tokenResponse.access_token")?c.useRefreshToken?(s("Auto-refresh failed! Please re-launch the app."),await this._clearState(),a.message+=`
`+v.expired,a):(s("Your session has expired and the useRefreshToken option is set to false. Please re-launch the app."),await this._clearState(),a.message+=`
`+v.expired,a):(a.message+=`
This app cannot be accessed directly. Please launch it as SMART app!`,a):a}).catch(a=>{throw a.status==403&&s("Permission denied! Please make sure that you have requested the proper scopes."),a}).then(async a=>!a||typeof a=="string"||a instanceof Response?r.includeResponse?{body:a,response:u}:a:(await this.fetchReferences(a,c.resolveReferences,c.graph,n,r),Promise.resolve(a).then(async f=>{if(f&&f.resourceType=="Bundle"){let g=f.link||[];if(c.flat&&(f=(f.entry||[]).map(m=>m.resource)),c.onPage&&await c.onPage(f,{...n}),--c.pageLimit){let m=g.find(h=>h.relation=="next");if(f=M(f),m&&m.url){let h=await this.request({url:m.url,signal:d},c,n);return c.onPage?null:c.resolveReferences.length?(Object.assign(n,h.references),f.concat(M(h.data||h))):f.concat(M(h))}}}return f}).then(f=>{if(c.graph)n={};else if(!c.onPage&&c.resolveReferences.length)return{data:f,references:n};return f}).then(f=>r.includeResponse?{body:f,response:u}:f)))}refreshIfNeeded(r={}){let i=this.getState("tokenResponse.access_token"),n=this.getState("tokenResponse.refresh_token"),s=this.state.expiresAt||0;return i&&n&&s-10<Date.now()/1e3?this.refresh(r):Promise.resolve(this.state)}refresh(r={}){let i=S.extend("client:refresh");i("Attempting to refresh with refresh_token...");let n=this.state?.tokenResponse?.refresh_token;p(n,"Unable to refresh. No refresh_token found.");let s=this.state.tokenUri;p(s,"Unable to refresh. No tokenUri found.");let o=this.getState("tokenResponse.scope")||"",c=o.search(/\boffline_access\b/)>-1,d=o.search(/\bonline_access\b/)>-1;if(p(c||d,"Unable to refresh. No offline_access or online_access scope found."),!this._refreshTask){let l=`grant_type=refresh_token&refresh_token=${encodeURIComponent(n)}`;this.environment.options.refreshTokenWithClientId&&(l+=`&client_id=${this.state.clientId}`);let u={credentials:this.environment.options.refreshTokenWithCredentials||"same-origin",...r,method:"POST",mode:"cors",headers:{...r.headers||{},"content-type":"application/x-www-form-urlencoded"},body:l};if(!("authorization"in u.headers)){let{clientSecret:a,clientId:f}=this.state;a&&(u.headers.authorization="Basic "+this.environment.btoa(f+":"+a))}this._refreshTask=O(s,u).then(a=>(p(a.access_token,"No access token received"),i("Received new access token response %O",a),this.state.tokenResponse={...this.state.tokenResponse,...a},this.state.expiresAt=he(a,this.environment),this.state)).catch(a=>{throw this.state?.tokenResponse?.refresh_token&&(i("Deleting the expired or invalid refresh token."),delete this.state.tokenResponse.refresh_token),a}).finally(()=>{this._refreshTask=null;let a=this.state.key;a?this.environment.getStorage().set(a,this.state):i("No 'key' found in Clint.state. Cannot persist the instance.")})}return this._refreshTask}byCode(r,i){return Ce(r,i)}byCodes(r,i){return $e(r,i)}getPath(r,i=""){return k(r,i)}getState(r=""){return k({...this.state},r)}}});function V(){return typeof window=="object"}async function _t(e="/",t){let r=String(e).replace(/\/*$/,"/")+".well-known/smart-configuration";return Re(r,t).catch(i=>{throw new Error(`Failed to fetch the well-known json "${r}". ${i.message}`)})}async function Ot(e="/",t){return _t(e,t).then(r=>{if(!r.authorization_endpoint||!r.token_endpoint)throw new Error("Invalid wellKnownJson");return{registrationUri:r.registration_endpoint||"",authorizeUri:r.authorization_endpoint,tokenUri:r.token_endpoint,codeChallengeMethods:r.code_challenge_methods_supported||[]}})}async function qt(e="/",t){return W(e,t).then(r=>{let i="http://fhir-registry.smarthealthit.org/StructureDefinition/oauth-uris",n=(k(r||{},"rest.0.security.extension")||[]).filter(o=>o.url===i).map(o=>o.extension)[0],s={registrationUri:"",authorizeUri:"",tokenUri:"",codeChallengeMethods:[]};return n&&n.forEach(o=>{o.url==="register"&&(s.registrationUri=o.valueUri),o.url==="authorize"&&(s.authorizeUri=o.valueUri),o.url==="token"&&(s.tokenUri=o.valueUri)}),s})}async function Bt(e="/",t,r){return Ot(e,t).catch(()=>qt(e,r))}async function pe(e,t={}){let r=e.getUrl();if(Array.isArray(t)){let R=r.searchParams.get("iss")||r.searchParams.get("fhirServiceUrl");if(!R)throw new Error('Passing in an "iss" url parameter is required if authorize uses multiple configurations');let B=t.find(H=>{if(H.issMatch){if(typeof H.issMatch=="function")return!!H.issMatch(R);if(typeof H.issMatch=="string")return H.issMatch===R;if(H.issMatch instanceof RegExp)return H.issMatch.test(R)}return!1});return p(B,`No configuration found matching the current "iss" parameter "${R}"`),await pe(e,B)}let{clientSecret:i,fakeTokenResponse:n,encounterId:s,target:o,width:c,height:d,pkceMode:l,clientPublicKeySetUrl:u,redirect_uri:a,client_id:f}=t,{iss:g,launch:m,patientId:h,fhirServiceUrl:w,redirectUri:y,noRedirect:q,scope:$="",clientId:U,completeInTarget:Z,clientPrivateJwk:Q,stateKey:F}=t,E=e.getStorage();g=r.searchParams.get("iss")||g,w=r.searchParams.get("fhirServiceUrl")||w,m=r.searchParams.get("launch")||m,h=r.searchParams.get("patientId")||h,U=r.searchParams.get("clientId")||U,U||(U=f),y||(y=a),y?y.match(/^https?\:\/\//)||(y=e.relative(y)):y=e.relative(".");let L=String(g||w||"");if(!L)throw new Error("No server url found. It must be specified as `iss` or as `fhirServiceUrl` parameter");if(g&&C("Making %s launch...",m?"EHR":"standalone"),m&&!$.match(/launch/)&&($+=" launch"),V()){let R=We(),B=Ve();(R||B)&&Z!==!0&&Z!==!1&&(Z=R,console.warn('Your app is being authorized from within an iframe or popup window. Please be explicit and provide a "completeInTarget" option. Use "true" to complete the authorization in the same window, or "false" to try to complete it in the parent or the opener window. See http://docs.smarthealthit.org/client-js/api.html'))}let Ue=await E.get(_);await E.unset(Ue),F=F??je(16);let P={clientId:U,scope:$,redirectUri:y,serverUrl:L,clientSecret:i,clientPrivateJwk:Q,tokenResponse:{},key:F,completeInTarget:Z,clientPublicKeySetUrl:u};(V()?k(e,"options.fullSessionStorageSupport"):!0)&&await E.set(_,F),n&&Object.assign(P.tokenResponse,n),h&&Object.assign(P.tokenResponse,{patient:h}),s&&Object.assign(P.tokenResponse,{encounter:s});let T=y+"?state="+encodeURIComponent(F);if(w&&!g)return C("Making fake launch..."),await E.set(F,P),q?T:await e.redirect(T);let Ie=await Bt(L,t.wellKnownRequestOptions,t.conformanceRequestOptions);if(Object.assign(P,Ie),await E.set(F,P),!P.authorizeUri)return q?T:await e.redirect(T);let oe=["response_type=code","client_id="+encodeURIComponent(U||""),"scope="+encodeURIComponent($),"redirect_uri="+encodeURIComponent(y),"aud="+encodeURIComponent(L),"state="+encodeURIComponent(F)];if(m&&oe.push("launch="+encodeURIComponent(m)),Mt(Ie.codeChallengeMethods.includes("S256"),l)){let R=await e.security.generatePKCEChallenge();Object.assign(P,R),await E.set(F,P),oe.push("code_challenge="+P.codeChallenge),oe.push("code_challenge_method=S256")}if(T=P.authorizeUri+"?"+oe.join("&"),q)return T;if(o&&V()){let R;if(R=await Je(o,c,d),R!==self)try{R.sessionStorage.removeItem(Ue),R.sessionStorage.setItem(F,JSON.stringify(P))}catch(B){S('Failed to modify window.sessionStorage. Perhaps it is from different origin?. Failing back to "_self". %s',B),R=self}if(R!==self)try{R.location.href=T,self.addEventListener("message",Ge)}catch(B){S('Failed to modify window.location. Perhaps it is from different origin?. Failing back to "_self". %s',B),self.location.href=T}else self.location.href=T;return}else return await e.redirect(T)}function Mt(e,t){if(t==="disabled")return!1;if(t==="unsafeV1")return!0;if(t==="required"){if(!e)throw new Error("Required PKCE code challenge method (`S256`) was not found in the server's codeChallengeMethods declaration.");return!0}return e}function We(){try{return self!==top&&parent!==self}catch{return!0}}function Ve(){try{return self===top&&!!opener&&opener!==self&&!!window.name}catch{return!1}}function Ge(e){e.data.type=="completeAuth"&&e.origin===new URL(self.location.href).origin&&(window.removeEventListener("message",Ge),window.location.href=e.data.url)}async function Fe(e,t={}){let r=e.getUrl(),i=e.getStorage(),n=r.searchParams,s=n.get("state")||t.stateKey,o=n.get("code")||t.code,c=n.get("error"),d=n.get("error_description");if(s||(s=await i.get(_)),c||d)throw new Error([c,d].filter(Boolean).join(": "));C("key: %s, code: %s",s,o),p(s,"No 'state' parameter found. Please (re)launch the app.");let l=await i.get(s),u=V()?k(e,"options.fullSessionStorageSupport"):!0;if(V()&&l&&!l.completeInTarget){let m=We(),h=Ve();if((m||h)&&!r.searchParams.get("complete")){r.searchParams.set("complete","1");let{href:w,origin:y}=r;return m&&parent.postMessage({type:"completeAuth",url:w},y),h&&(opener.postMessage({type:"completeAuth",url:w},y),window.close()),new Promise(()=>{})}}r.searchParams.delete("complete");let a=!!(n.has("state")||t.stateKey);if(V()&&k(e,"options.replaceBrowserHistory")&&(o||a)&&(o&&(n.delete("code"),C("Removed code parameter from the url.")),a&&u&&(n.delete("state"),C("Removed state parameter from the url.")),window.history.replaceState&&window.history.replaceState({},"",r.href)),p(l,"No state found! Please (re)launch the app."),!(!o||l.tokenResponse?.access_token)&&l.tokenUri){p(o,"'code' url parameter is required"),C("Preparing to exchange the code for access token...");let m=await zt(e,{code:o,state:l,clientPublicKeySetUrl:t.clientPublicKeySetUrl,privateKey:t.privateKey||l.clientPrivateJwk});C("Token request options: %O",m);let h=await O(l.tokenUri,m);C("Token response: %O",h),p(h.access_token,"Failed to obtain access token."),l.expiresAt=he(h,e),l={...l,tokenResponse:h},await i.set(s,l),C("Authorization successful!")}else C(l.tokenResponse?.access_token?"Already authorized":"No authorization needed");u&&await i.set(_,s);let g=new z(e,l);return C("Created client instance: %O",g),g}async function zt(e,{code:t,state:r,clientPublicKeySetUrl:i,privateKey:n}){let{redirectUri:s,clientSecret:o,tokenUri:c,clientId:d,codeVerifier:l}=r;p(s,"Missing state.redirectUri"),p(c,"Missing state.tokenUri"),p(d,"Missing state.clientId");let u={method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:`code=${t}&grant_type=authorization_code&redirect_uri=${encodeURIComponent(s)}`};if(o)u.headers.authorization="Basic "+e.btoa(d+":"+o),C("Using state.clientSecret to construct the authorization header: %s",u.headers.authorization);else if(n){let a="key"in n?n.key:await e.security.importJWK(n),f={typ:"JWT",kid:n.kid,jku:i||r.clientPublicKeySetUrl},g={iss:d,sub:d,aud:c,jti:e.base64urlencode(e.security.randomBytes(32)),exp:De(120)},m=await e.security.signCompactJws(n.alg,a,f,g);u.body+=`&client_assertion_type=${encodeURIComponent("urn:ietf:params:oauth:client-assertion-type:jwt-bearer")}`,u.body+=`&client_assertion=${encodeURIComponent(m)}`,C("Using state.clientPrivateJwk to add a client_assertion to the POST body")}else C("Public client detected; adding state.clientId to the POST body"),u.body+=`&client_id=${encodeURIComponent(d)}`;return l&&(C("Found state.codeVerifier, adding to the POST body"),u.body+="&code_verifier="+l),u}async function Ye(e,t,r){let i=e.getUrl(),n=i.searchParams.get("code"),s=i.searchParams.get("state");if(n&&s)return Fe(e,r);let o=e.getStorage(),c=s||await o.get(_),d=await o.get(c);return d?new z(e,d):pe(e,t).then(()=>new Promise(()=>{}))}var C,Ze=I(()=>{"use strict";de();Se();ee();C=S.extend("oauth2")});var re,Qe=I(()=>{"use strict";re=class{async get(t){let r=sessionStorage[t];return r?JSON.parse(r):null}async set(t,r){return sessionStorage[t]=JSON.stringify(r),r}async unset(t){return t in sessionStorage?(delete sessionStorage[t],!0):!1}}});var G,Xe,et,Ht,ne,ge,jt,b,tt,nt,it,Dt,st,Pe,Y,$t,Lt,Jt,rt,Nt,ie,Kt,Wt,Vt,Gt,ot,Yt,Zt,Qt,at,ke=I(()=>{G=typeof Buffer=="function",Xe=typeof TextDecoder=="function"?new TextDecoder:void 0,et=typeof TextEncoder=="function"?new TextEncoder:void 0,Ht="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",ne=Array.prototype.slice.call(Ht),ge=(e=>{let t={};return e.forEach((r,i)=>t[r]=i),t})(ne),jt=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,b=String.fromCharCode.bind(String),tt=typeof Uint8Array.from=="function"?Uint8Array.from.bind(Uint8Array):e=>new Uint8Array(Array.prototype.slice.call(e,0)),nt=e=>e.replace(/=/g,"").replace(/[+\/]/g,t=>t=="+"?"-":"_"),it=e=>e.replace(/[^A-Za-z0-9\+\/]/g,""),Dt=e=>{let t,r,i,n,s="",o=e.length%3;for(let c=0;c<e.length;){if((r=e.charCodeAt(c++))>255||(i=e.charCodeAt(c++))>255||(n=e.charCodeAt(c++))>255)throw new TypeError("invalid character found");t=r<<16|i<<8|n,s+=ne[t>>18&63]+ne[t>>12&63]+ne[t>>6&63]+ne[t&63]}return o?s.slice(0,o-3)+"===".substring(o):s},st=typeof btoa=="function"?e=>btoa(e):G?e=>Buffer.from(e,"binary").toString("base64"):Dt,Pe=G?e=>Buffer.from(e).toString("base64"):e=>{let r=[];for(let i=0,n=e.length;i<n;i+=4096)r.push(b.apply(null,e.subarray(i,i+4096)));return st(r.join(""))},Y=(e,t=!1)=>t?nt(Pe(e)):Pe(e),$t=e=>{if(e.length<2){var t=e.charCodeAt(0);return t<128?e:t<2048?b(192|t>>>6)+b(128|t&63):b(224|t>>>12&15)+b(128|t>>>6&63)+b(128|t&63)}else{var t=65536+(e.charCodeAt(0)-55296)*1024+(e.charCodeAt(1)-56320);return b(240|t>>>18&7)+b(128|t>>>12&63)+b(128|t>>>6&63)+b(128|t&63)}},Lt=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,Jt=e=>e.replace(Lt,$t),rt=G?e=>Buffer.from(e,"utf8").toString("base64"):et?e=>Pe(et.encode(e)):e=>st(Jt(e)),Nt=(e,t=!1)=>t?nt(rt(e)):rt(e),ie=e=>Nt(e,!0),Kt=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,Wt=e=>{switch(e.length){case 4:var t=(7&e.charCodeAt(0))<<18|(63&e.charCodeAt(1))<<12|(63&e.charCodeAt(2))<<6|63&e.charCodeAt(3),r=t-65536;return b((r>>>10)+55296)+b((r&1023)+56320);case 3:return b((15&e.charCodeAt(0))<<12|(63&e.charCodeAt(1))<<6|63&e.charCodeAt(2));default:return b((31&e.charCodeAt(0))<<6|63&e.charCodeAt(1))}},Vt=e=>e.replace(Kt,Wt),Gt=e=>{if(e=e.replace(/\s+/g,""),!jt.test(e))throw new TypeError("malformed base64.");e+="==".slice(2-(e.length&3));let t,r,i,n=[];for(let s=0;s<e.length;)t=ge[e.charAt(s++)]<<18|ge[e.charAt(s++)]<<12|(r=ge[e.charAt(s++)])<<6|(i=ge[e.charAt(s++)]),r===64?n.push(b(t>>16&255)):i===64?n.push(b(t>>16&255,t>>8&255)):n.push(b(t>>16&255,t>>8&255,t&255));return n.join("")},ot=typeof atob=="function"?e=>atob(it(e)):G?e=>Buffer.from(e,"base64").toString("binary"):Gt,Yt=G?e=>tt(Buffer.from(e,"base64")):e=>tt(ot(e).split("").map(t=>t.charCodeAt(0))),Zt=G?e=>Buffer.from(e,"base64").toString("utf8"):Xe?e=>Xe.decode(Yt(e)):e=>Vt(ot(e)),Qt=e=>it(e.replace(/[-_]/g,t=>t=="-"?"+":"/")),at=e=>Zt(Qt(e))});var me={};gt(me,{digestSha256:()=>lt,generatePKCEChallenge:()=>er,importJWK:()=>tr,randomBytes:()=>ut,signCompactJws:()=>rr});function ut(e){return ct.getRandomValues(new Uint8Array(e))}async function lt(e){let t=new TextEncoder().encode(e),r=await Ae.digest("SHA-256",t);return new Uint8Array(r)}async function tr(e){if(!e.alg)throw new Error('The "alg" property of the JWK must be set to "ES384" or "RS384"');if(Array.isArray(e.key_ops)||(e.key_ops=["sign"]),!e.key_ops.includes("sign"))throw new Error('The "key_ops" property of the JWK does not contain "sign"');try{return await Ae.importKey("jwk",e,Xt[e.alg],e.ext===!0,e.key_ops)}catch(t){throw new Error(`The ${e.alg} is not supported by this browser: ${t}`)}}async function rr(e,t,r,i){let n=JSON.stringify({...r,alg:e}),s=JSON.stringify(i),o=`${ie(n)}.${ie(s)}`,c=await Ae.sign({...t.algorithm,hash:"SHA-384"},t,new TextEncoder().encode(o));return`${o}.${Y(new Uint8Array(c),!0)}`}var ct,Ae,Xt,er,ft=I(()=>{"use strict";ke();if(!globalThis?.crypto?.subtle)throw globalThis.isSecureContext?new Error("Some of the required subtle crypto functionality is not available in the current environment (no crypto.subtle). Please use a polyfill to provide this functionality."):new Error("Some of the required subtle crypto functionality is not available unless you run this app in secure context (using HTTPS or running locally). See https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts");ct=globalThis.crypto,Ae=ct.subtle,Xt={ES384:{name:"ECDSA",namedCurve:"P-384"},RS384:{name:"RSASSA-PKCS1-v1_5",modulusLength:4096,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-384"}}};er=async(e=96)=>{let t=ut(e),r=Y(t,!0);return{codeChallenge:Y(await lt(r),!0),codeVerifier:r}}});var se,ht=I(()=>{"use strict";Ze();Se();Qe();ft();ke();se=class{constructor(t={}){this._url=null;this._storage=null;this.security=me;this.options={replaceBrowserHistory:!0,fullSessionStorageSupport:!0,refreshTokenWithCredentials:"same-origin",...t}}relative(t){return new URL(t,this.getUrl().href).href}get fhir(){return typeof fhir=="function"?fhir:null}getUrl(){return this._url||(this._url=new URL(location+"")),this._url}redirect(t){location.href=t}getStorage(){return this._storage||(this._storage=new re),this._storage}atob(t){return window.atob(t)}btoa(t){return window.btoa(t)}base64urlencode(t){return typeof t=="string"?ie(t):Y(t,!0)}base64urldecode(t){return at(t)}getSmartApi(){return{ready:(...t)=>Fe(this,...t),authorize:t=>pe(this,t),init:t=>Ye(this,t),client:t=>new z(this,t),options:this.options,utils:{security:me}}}}});var fr=ae((Jr,dt)=>{ht();xe();var nr=new se,{ready:ir,authorize:sr,init:or,client:ar,options:cr,utils:ur}=nr.getSmartApi(),lr={AbortController:window.AbortController,client:ar,FhirClient:D,utils:ur,oauth2:{settings:cr,ready:ir,authorize:sr,init:or}};dt.exports=lr});return fr();})();
//# sourceMappingURL=fhir-client.min.js.map
