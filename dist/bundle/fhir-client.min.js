// @ts-nocheck
(() => {
"use strict";var FHIR=(()=>{var st=Object.create;var se=Object.defineProperty;var ot=Object.getOwnPropertyDescriptor;var at=Object.getOwnPropertyNames;var ct=Object.getPrototypeOf,ut=Object.prototype.hasOwnProperty;var pe=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),Pe=(t,e)=>{for(var r in e)se(t,r,{get:e[r],enumerable:!0})},ke=(t,e,r,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of at(e))!ut.call(t,n)&&n!==r&&se(t,n,{get:()=>e[n],enumerable:!(i=ot(e,n))||i.enumerable});return t};var lt=(t,e,r)=>(r=t!=null?st(ct(t)):{},ke(e||!t||!t.__esModule?se(r,"default",{value:t,enumerable:!0}):r,t)),ft=t=>ke(se({},"__esModule",{value:!0}),t);var Te=pe((hr,ve)=>{var $=1e3,J=$*60,N=J*60,H=N*24,ht=H*7,dt=H*365.25;ve.exports=function(t,e){e=e||{};var r=typeof t;if(r==="string"&&t.length>0)return pt(t);if(r==="number"&&isFinite(t))return e.long?mt(t):gt(t);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(t))};function pt(t){if(t=String(t),!(t.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(t);if(e){var r=parseFloat(e[1]),i=(e[2]||"ms").toLowerCase();switch(i){case"years":case"year":case"yrs":case"yr":case"y":return r*dt;case"weeks":case"week":case"w":return r*ht;case"days":case"day":case"d":return r*H;case"hours":case"hour":case"hrs":case"hr":case"h":return r*N;case"minutes":case"minute":case"mins":case"min":case"m":return r*J;case"seconds":case"second":case"secs":case"sec":case"s":return r*$;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return r;default:return}}}}function gt(t){var e=Math.abs(t);return e>=H?Math.round(t/H)+"d":e>=N?Math.round(t/N)+"h":e>=J?Math.round(t/J)+"m":e>=$?Math.round(t/$)+"s":t+"ms"}function mt(t){var e=Math.abs(t);return e>=H?oe(t,e,H,"day"):e>=N?oe(t,e,N,"hour"):e>=J?oe(t,e,J,"minute"):e>=$?oe(t,e,$,"second"):t+" ms"}function oe(t,e,r,i){var n=e>=r*1.5;return Math.round(t/r)+" "+i+(n?"s":"")}});var _e=pe((dr,Ee)=>{function yt(t){r.debug=r,r.default=r,r.coerce=f,r.disable=o,r.enable=n,r.enabled=l,r.humanize=Te(),r.destroy=u,Object.keys(t).forEach(a=>{r[a]=t[a]}),r.names=[],r.skips=[],r.formatters={};function e(a){let c=0;for(let g=0;g<a.length;g++)c=(c<<5)-c+a.charCodeAt(g),c|=0;return r.colors[Math.abs(c)%r.colors.length]}r.selectColor=e;function r(a){let c,g=null,h,p;function m(...w){if(!m.enabled)return;let y=m,O=Number(new Date),D=O-(c||O);y.diff=D,y.prev=c,y.curr=O,c=O,w[0]=r.coerce(w[0]),typeof w[0]!="string"&&w.unshift("%O");let U=0;w[0]=w[0].replace(/%([a-zA-Z%])/g,(Z,F)=>{if(Z==="%%")return"%";U++;let T=r.formatters[F];if(typeof T=="function"){let L=w[U];Z=T.call(y,L),w.splice(U,1),U--}return Z}),r.formatArgs.call(y,w),(y.log||r.log).apply(y,w)}return m.namespace=a,m.useColors=r.useColors(),m.color=r.selectColor(a),m.extend=i,m.destroy=r.destroy,Object.defineProperty(m,"enabled",{enumerable:!0,configurable:!1,get:()=>g!==null?g:(h!==r.namespaces&&(h=r.namespaces,p=r.enabled(a)),p),set:w=>{g=w}}),typeof r.init=="function"&&r.init(m),m}function i(a,c){let g=r(this.namespace+(typeof c>"u"?":":c)+a);return g.log=this.log,g}function n(a){r.save(a),r.namespaces=a,r.names=[],r.skips=[];let c=(typeof a=="string"?a:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(let g of c)g[0]==="-"?r.skips.push(g.slice(1)):r.names.push(g)}function s(a,c){let g=0,h=0,p=-1,m=0;for(;g<a.length;)if(h<c.length&&(c[h]===a[g]||c[h]==="*"))c[h]==="*"?(p=h,m=g,h++):(g++,h++);else if(p!==-1)h=p+1,m++,g=m;else return!1;for(;h<c.length&&c[h]==="*";)h++;return h===c.length}function o(){let a=[...r.names,...r.skips.map(c=>"-"+c)].join(",");return r.enable(""),a}function l(a){for(let c of r.skips)if(s(a,c))return!1;for(let c of r.names)if(s(a,c))return!0;return!1}function f(a){return a instanceof Error?a.stack||a.message:a}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return r.enable(r.load()),r}Ee.exports=yt});var Oe=pe((x,ae)=>{x.formatArgs=Rt;x.save=bt;x.load=Ct;x.useColors=wt;x.storage=xt();x.destroy=(()=>{let t=!1;return()=>{t||(t=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();x.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function wt(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let t;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(t=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(t[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function Rt(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+ae.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;t.splice(1,0,e,"color: inherit");let r=0,i=0;t[0].replace(/%[a-zA-Z%]/g,n=>{n!=="%%"&&(r++,n==="%c"&&(i=r))}),t.splice(i,0,e)}x.log=console.debug||console.log||(()=>{});function bt(t){try{t?x.storage.setItem("debug",t):x.storage.removeItem("debug")}catch{}}function Ct(){let t;try{t=x.storage.getItem("debug")||x.storage.getItem("DEBUG")}catch{}return!t&&typeof process<"u"&&"env"in process&&(t=process.env.DEBUG),t}function xt(){try{return localStorage}catch{}}ae.exports=_e()(x);var{formatters:St}=ae.exports;St.j=function(t){try{return JSON.stringify(t)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var ar={};Pe(ar,{default:()=>or});var Q=class extends Error{statusCode;status;statusText;response;constructor(e){super(`${e.status} ${e.statusText}
URL: ${e.url}`),this.name="HttpError",this.response=e,this.statusCode=e.status,this.status=e.status,this.statusText=e.statusText}async parse(){if(!this.response.bodyUsed)try{let e=this.response.headers.get("content-type")||"text/plain";if(e.match(/\bjson\b/i)){let r=await this.response.json();r.error?(this.message+=`
`+r.error,r.error_description&&(this.message+=": "+r.error_description)):this.message+=`

`+JSON.stringify(r,null,4)}else if(e.match(/^text\//i)){let r=await this.response.text();r&&(this.message+=`

`+r)}}catch{}return this}toJSON(){return{name:this.name,statusCode:this.statusCode,status:this.status,statusText:this.statusText,message:this.message}}};var Ae=["Account","AdverseEvent","AllergyIntolerance","Appointment","AppointmentResponse","AuditEvent","Basic","BodySite","BodyStructure","CarePlan","CareTeam","ChargeItem","Claim","ClaimResponse","ClinicalImpression","Communication","CommunicationRequest","Composition","Condition","Consent","Coverage","CoverageEligibilityRequest","CoverageEligibilityResponse","DetectedIssue","DeviceRequest","DeviceUseRequest","DeviceUseStatement","DiagnosticOrder","DiagnosticReport","DocumentManifest","DocumentReference","EligibilityRequest","Encounter","EnrollmentRequest","EpisodeOfCare","ExplanationOfBenefit","FamilyMemberHistory","Flag","Goal","Group","ImagingManifest","ImagingObjectSelection","ImagingStudy","Immunization","ImmunizationEvaluation","ImmunizationRecommendation","Invoice","List","MeasureReport","Media","MedicationAdministration","MedicationDispense","MedicationOrder","MedicationRequest","MedicationStatement","MolecularSequence","NutritionOrder","Observation","Order","Patient","Person","Procedure","ProcedureRequest","Provenance","QuestionnaireResponse","ReferralRequest","RelatedPerson","RequestGroup","ResearchSubject","RiskAssessment","Schedule","ServiceRequest","Specimen","SupplyDelivery","SupplyRequest","VisionPrescription"],Ue={"0.4.0":2,"0.5.0":2,"1.0.0":2,"1.0.1":2,"1.0.2":2,"1.1.0":3,"1.4.0":3,"1.6.0":3,"1.8.0":3,"3.0.0":3,"3.0.1":3,"3.3.0":4,"3.5.0":4,"4.0.0":4,"4.0.1":4},Ie=["patient","subject","requester","member","actor","beneficiary"],E="SMART_KEY";var qe=lt(Oe()),S=(0,qe.default)("FHIR");var ce={},Be={cm({code:t,value:e}){if(ge({code:t,value:e}),t=="cm")return e;if(t=="m")return e*100;if(t=="in"||t=="[in_us]"||t=="[in_i]")return e*2.54;if(t=="ft"||t=="[ft_us]")return e*30.48;throw new Error("Unrecognized length unit: "+t)},kg({code:t,value:e}){if(ge({code:t,value:e}),t=="kg")return e;if(t=="g")return e/1e3;if(t.match(/lb/))return e/2.20462;if(t.match(/oz/))return e/35.274;throw new Error("Unrecognized weight unit: "+t)},any(t){return ge(t),t.value}};function ge({value:t,code:e}){if(typeof t!="number")throw new Error("Found a non-numerical unit: "+t+" "+e)}async function Ft(t){if(!t.ok){let e=new Q(t);throw await e.parse(),e}return t}function Pt(t){return t.text().then(e=>e.length?JSON.parse(e):"")}function me(t){if(!t)return t;if(Array.isArray(t))return t.map(r=>r&&typeof r=="object"?me(r):r);let e={};return Object.keys(t).forEach(r=>{let i=r.toLowerCase(),n=t[r];e[i]=n&&typeof n=="object"?me(n):n}),e}async function _(t,e={}){let{includeResponse:r,...i}=e;return fetch(t,{mode:"cors",...i,headers:{accept:"application/json",...me(i.headers)}}).then(Ft).then(n=>{let s=n.headers.get("content-type")+"";return s.match(/\bjson\b/i)?Pt(n).then(o=>({res:n,body:o})):s.match(/^text\//i)?n.text().then(o=>({res:n,body:o})):{res:n}}).then(({res:n,body:s})=>{if(!s&&n.status==201){let o=n.headers.get("location");if(o)return _(o,{...i,method:"GET",body:null,includeResponse:r})}return r?{body:s,response:n}:s===void 0?n:s})}function ye(t,e,r=!1){return r||!ce[t]?(ce[t]=_(t,e),ce[t]):Promise.resolve(ce[t])}function K(t="/",e){let r=String(t).replace(/\/*$/,"/")+"metadata";return ye(r,e).catch(i=>{throw new Error(`Failed to fetch the conformance statement from "${r}". ${i}`)})}function k(t,e=""){if(e=e.trim(),!e)return t;let r=e.split("."),i=t;for(;i&&r.length;){let n=r.shift();if(!n&&Array.isArray(i))return i.map(s=>k(s,r.join(".")));i=i[n]}return i}function ue(t,e,r,i=!1){return e.trim().split(".").reduce((n,s,o,l)=>{if(n&&o===l.length-1)n[s]=r;else return n&&n[s]===void 0&&i&&(n[s]=l[o+1].match(/^[0-9]+$/)?[]:{}),n?n[s]:void 0},t),t}function B(t){return Array.isArray(t)?t:[t]}function X(t,e){return t.match(/^http/)||t.match(/^urn/)?t:String(e||"").replace(/\/+$/,"")+"/"+t.replace(/^\/+/,"")}function Me(t=8,e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"){let r=[],i=e.length;for(;t--;)r.push(e.charAt(Math.floor(Math.random()*i)));return r.join("")}function we(t,e){let r=t.split(".")[1];return r?JSON.parse(e.atob(r)):null}function ze(t=120,e){return Math.floor(+(e||new Date)/1e3+t)}function le(t,e){let r=Math.floor(Date.now()/1e3);if(t.expires_in)return r+t.expires_in;if(t.access_token){let i=we(t.access_token,e);if(i&&i.exp)return i.exp}return r+300}function Re(t,e){let r={};function i(n,s){n&&Array.isArray(n.coding)&&n.coding.forEach(({code:o})=>{o&&(r[o]=r[o]||[],r[o].push(s))})}return B(t).forEach(n=>{n.resourceType==="Observation"&&n[e]&&(Array.isArray(n[e])?n[e].forEach(s=>i(s,n)):i(n[e],n))}),r}function He(t,e){let r=Re(t,e);return(...i)=>i.filter(n=>n+""in r).reduce((n,s)=>n.concat(r[s+""]),[])}function je(t,e){let i=(k(t,"rest.0.resource")||[]).find(s=>s.type===e);if(!i)throw new Error(`Resource "${e}" is not supported by this FHIR server`);if(!Array.isArray(i.searchParam))throw new Error(`No search parameters supported for "${e}" on this FHIR server`);if(e=="Patient"&&i.searchParam.find(s=>s.name=="_id"))return"_id";let n=Ie.find(s=>i.searchParam.find(o=>o.name==s));if(!n)throw new Error("I don't know what param to use for "+e);return n}async function De(t,e=800,r=720){if(typeof t=="function"&&(t=await t()),t&&typeof t=="object")return t;if(typeof t!="string")return S("Invalid target type '%s'. Failing back to '_self'.",typeof t),self;if(t=="_self")return self;if(t=="_parent")return parent;if(t=="_top")return top||self;if(t=="_blank"){let n,s=null;try{if(s=window.open("","SMARTAuthPopup"),!s)throw new Error("Perhaps window.open was blocked")}catch(o){n=o}return s||(S("Cannot open window. Failing back to '_self'. %s",n),self)}if(t=="popup"){let n,s=null;try{if(s=window.open("","SMARTAuthPopup",["height="+r,"width="+e,"menubar=0","resizable=1","status=0","top="+(screen.height-r)/2,"left="+(screen.width-e)/2].join(",")),!s)throw new Error("Perhaps the popup window was blocked")}catch(o){n=o}return s||(S("Cannot open window. Failing back to '_self'. %s",n),self)}let i=frames[t];return i||(S("Unknown target '%s'. Failing back to '_self'.",t),self)}function d(t,e){if(!t)throw new Error(e)}function Le(t){d(Array.isArray(t),"The JSON patch must be an array"),d(t.length>0,"The JSON patch array should not be empty"),t.forEach(e=>{d(["add","replace","test","move","copy","remove"].indexOf(e.op)>-1,'Each patch operation must have an "op" property which must be one of: "add", "replace", "test", "move", "copy", "remove"'),d(e.path&&typeof e.path,`Invalid "${e.op}" operation. Missing "path" property`),e.op=="add"||e.op=="replace"||e.op=="test"?(d("value"in e,`Invalid "${e.op}" operation. Missing "value" property`),d(Object.keys(e).length==3,`Invalid "${e.op}" operation. Contains unknown properties`)):e.op=="move"||e.op=="copy"?(d(typeof e.from=="string",`Invalid "${e.op}" operation. Requires a string "from" property`),d(Object.keys(e).length==3,`Invalid "${e.op}" operation. Contains unknown properties`)):d(Object.keys(e).length==2,`Invalid "${e.op}" operation. Contains unknown properties`)})}var I={expired:"Session expired! Please re-launch the app",noScopeForId:"Trying to get the ID of the selected %s. Please add 'launch' or 'launch/%s' to the requested scopes and try again.",noIfNoAuth:"You are trying to get %s but the app is not authorized yet.",noFreeContext:"Please don't use open fhir servers if you need to access launch context items like the %S."};var kt=S.extend("FhirClient"),j=class{fhirBaseUrl;constructor(e){d(e&&typeof e=="string"&&e.match(/https?:\/\/.+/),'A "fhirBaseUrl" string parameter is required and must begin with "http(s)"'),this.fhirBaseUrl=e}async create(e,r){return this.fhirRequest(e.resourceType,{...r,method:"POST",body:JSON.stringify(e),headers:{"content-type":"application/json",...(r||{}).headers}})}async update(e,r){return this.fhirRequest(`${e.resourceType}/${e.id}`,{...r,method:"PUT",body:JSON.stringify(e),headers:{"content-type":"application/json",...(r||{}).headers}})}async delete(e,r={}){return this.fhirRequest(e,{...r,method:"DELETE"})}async patch(e,r,i={}){return Le(r),this.fhirRequest(e,{...i,method:"PATCH",body:JSON.stringify(r),headers:{prefer:"return=presentation","content-type":"application/json-patch+json; charset=UTF-8",...i.headers}})}async resolveRef(e,r,i,n,s={}){let o=k(e,r);if(o){let l=Array.isArray(o);return Promise.all(B(o).filter(Boolean).map((f,u)=>{let a=f.reference;if(a)return this.fhirRequest(a,{...s,includeResponse:!1,cacheMap:n}).then(c=>{i&&(l?r.indexOf("..")>-1?ue(e,`${r.replace("..",`.${u}.`)}`,c):ue(e,`${r}.${u}`,c):ue(e,r,c))}).catch(c=>{if(c?.status===404)console.warn(`Missing reference ${a}. ${c}`);else throw c})}))}}async resolveReferences(e,r,i={}){await this.fetchReferences(e,r,!0,{},i)}async fetchReferences(e,r,i,n={},s={}){if(e.resourceType=="Bundle"){for(let u of e.entry||[])u.resource&&await this.fetchReferences(u.resource,r,i,n,s);return n}let o=r.map(u=>String(u).trim()).filter(Boolean);if(o=o.reduce((u,a)=>(u.includes(a)?kt('Duplicated reference path "%s"',a):u.push(a),u),[]),!o.length)return Promise.resolve(n);let l={};o.forEach(u=>{let a=u.split(".").length;l[a]||(l[a]=[]),l[a].push(u)});let f=Promise.resolve();return Object.keys(l).sort().forEach(u=>{let a=l[u];f=f.then(()=>Promise.all(a.map(c=>this.resolveRef(e,c,i,n,s))))}),await f,n}async getReferences(e,r,i={}){let n=await this.fetchReferences(e,r,!1,{},i),s={};for(let o in n)s[o]=await n[o];return s}async*resources(e,r){let i=0;for await(let n of this.pages(e,r))for(let s of n.entry||[]){if(r?.limit&&++i>r.limit)return;yield s.resource}}async*pages(e,r){let{limit:i,...n}=r||{},s=f=>this.fhirRequest(f,n),o=typeof e=="string"||e instanceof URL?await s(e):e,l=0;for(;o&&o.resourceType==="Bundle"&&(!i||++l<=i)&&(yield o,!n?.signal?.aborted);){let f=(o.link??[]).find(u=>u.relation==="next"&&typeof u.url=="string");if(!f)break;o=await s(f.url)}}async fhirRequest(e,r={}){d(r,"fhirRequest requires a uri as first argument");let i=e+"",n=X(i,this.fhirBaseUrl),{cacheMap:s}=r;return s?(i in s||(s[i]=_(n,r).then(o=>(s[i]=o,o)).catch(o=>{throw delete s[i],o})),s[i]):_(n,r)}async getFhirVersion(){return K(this.fhirBaseUrl).then(e=>e.fhirVersion)}async getFhirRelease(){return this.getFhirVersion().then(e=>Ue[e]??0)}};var A=S.extend("client");async function At(t,e){let r=X("/",e.state.serverUrl);async function i(n){let s=n.pathname.split("/").pop();d(s,`Invalid url "${n}"`),d(Ae.indexOf(s)>-1,`Cannot filter "${s}" resources by patient`);let o=await K(e.state.serverUrl),l=je(o,s);return n.searchParams.set(l,e.patient.id),n.href}return typeof t=="string"||t instanceof URL?{url:await i(new URL(t+"",r))}:(t.url=await i(new URL(t.url+"",r)),t)}var M=class extends j{state;environment;patient;encounter;user;api;_refreshTask;constructor(e,r){let i=typeof r=="string"?{serverUrl:r}:r;d(i.serverUrl&&i.serverUrl.match(/https?:\/\/.+/),'A "serverUrl" option is required and must begin with "http(s)"'),super(i.serverUrl),this.state=i,this.environment=e,this._refreshTask=null;let n=this;this.patient={get id(){return n.getPatientId()},read:s=>{let o=this.patient.id;return o?this.request({...s,url:`Patient/${o}`}):Promise.reject(new Error("Patient is not available"))},request:(s,o={})=>this.patient.id?(async()=>{let l=await At(s,this);return this.request(l,o)})():Promise.reject(new Error("Patient is not available"))},this.encounter={get id(){return n.getEncounterId()},read:s=>{let o=this.encounter.id;return o?this.request({...s,url:`Encounter/${o}`}):Promise.reject(new Error("Encounter is not available"))}},this.user={get fhirUser(){return n.getFhirUser()},get id(){return n.getUserId()},get resourceType(){return n.getUserType()},read:s=>{let o=this.user.fhirUser;return o?this.request({...s,url:o}):Promise.reject(new Error("User is not available"))}}}getPatientId(){let e=this.state.tokenResponse;return e?e.patient?e.patient:((this.state.scope||"").match(/\blaunch(\/patient)?\b/)?A("The ID of the selected patient is not available. Please check if your server supports that."):A(I.noScopeForId,"patient","patient"),null):(this.state.authorizeUri?A(I.noIfNoAuth,"the ID of the selected patient"):A(I.noFreeContext,"selected patient"),null)}getEncounterId(){let e=this.state.tokenResponse;return e?e.encounter?e.encounter:((this.state.scope||"").match(/\blaunch(\/encounter)?\b/)?A("The ID of the selected encounter is not available. Please check if your server supports that, and that the selected patient has any recorded encounters."):A(I.noScopeForId,"encounter","encounter"),null):(this.state.authorizeUri?A(I.noIfNoAuth,"the ID of the selected encounter"):A(I.noFreeContext,"selected encounter"),null)}getIdToken(){let e=this.state.tokenResponse;if(e){let r=e.id_token,i=this.state.scope||"";if(!r){let n=i.match(/\bopenid\b/),s=i.match(/\bprofile\b/),o=i.match(/\bfhirUser\b/);return A(!n||!(o||s)?"You are trying to get the id_token but you are not using the right scopes. Please add 'openid' and 'fhirUser' or 'profile' to the scopes you are requesting.":"The id_token is not available. Please check if your server supports that."),null}return we(r,this.environment)}return this.state.authorizeUri?A(I.noIfNoAuth,"the id_token"):A(I.noFreeContext,"id_token"),null}getFhirUser(){let e=this.getIdToken();return e?e.fhirUser?e.fhirUser.split("/").slice(-2).join("/"):e.profile:null}getUserId(){let e=this.getFhirUser();return e?e.split("/")[1]:null}getUserType(){let e=this.getFhirUser();return e?e.split("/")[0]:null}getAuthorizationHeader(){let e=this.getState("tokenResponse.access_token");if(e)return"Bearer "+e;let{username:r,password:i}=this.state;return r&&i?"Basic "+this.environment.btoa(r+":"+i):null}async _clearState(){let e=this.environment.getStorage(),r=await e.get(E);r&&await e.unset(r),await e.unset(E),this.state.tokenResponse={}}async request(e,r={},i={}){let n=S.extend("client:request");d(e,"request requires an url or request options as argument");let s;typeof e=="string"||e instanceof URL?(s=String(e),e={}):s=String(e.url),s=X(s,this.state.serverUrl);let o={graph:r.graph!==!1,flat:!!r.flat,pageLimit:r.pageLimit??1,resolveReferences:B(r.resolveReferences||[]),useRefreshToken:r.useRefreshToken!==!1,onPage:typeof r.onPage=="function"?r.onPage:void 0},l=e.signal||void 0;o.useRefreshToken&&await this.refreshIfNeeded({signal:l});let f=this.getAuthorizationHeader();f&&(e.headers={...e.headers,authorization:f}),n("%s, options: %O, fhirOptions: %O",s,e,o);let u;return super.fhirRequest(s,e).then(a=>e.includeResponse?(u=a.response,a.body):a).catch(async a=>{throw a.status==401?this.getState("tokenResponse.access_token")?o.useRefreshToken?(n("Auto-refresh failed! Please re-launch the app."),await this._clearState(),a.message+=`
`+I.expired,a):(n("Your session has expired and the useRefreshToken option is set to false. Please re-launch the app."),await this._clearState(),a.message+=`
`+I.expired,a):(a.message+=`
This app cannot be accessed directly. Please launch it as SMART app!`,a):a}).catch(a=>{throw a.status==403&&n("Permission denied! Please make sure that you have requested the proper scopes."),a}).then(async a=>!a||typeof a=="string"||a instanceof Response?e.includeResponse?{body:a,response:u}:a:(await this.fetchReferences(a,o.resolveReferences,o.graph,i,e),Promise.resolve(a).then(async c=>{if(c&&c.resourceType=="Bundle"){let g=c.link||[];if(o.flat&&(c=(c.entry||[]).map(h=>h.resource)),o.onPage&&await o.onPage(c,{...i}),--o.pageLimit){let h=g.find(p=>p.relation=="next");if(c=B(c),h&&h.url){let p=await this.request({url:h.url,signal:l},o,i);return o.onPage?null:o.resolveReferences.length?(Object.assign(i,p.references),c.concat(B(p.data||p))):c.concat(B(p))}}}return c}).then(c=>{if(o.graph)i={};else if(!o.onPage&&o.resolveReferences.length)return{data:c,references:i};return c}).then(c=>e.includeResponse?{body:c,response:u}:c)))}refreshIfNeeded(e={}){let r=this.getState("tokenResponse.access_token"),i=this.getState("tokenResponse.refresh_token"),n=this.state.expiresAt||0;return r&&i&&n-10<Date.now()/1e3?this.refresh(e):Promise.resolve(this.state)}refresh(e={}){let r=S.extend("client:refresh");r("Attempting to refresh with refresh_token...");let i=this.state?.tokenResponse?.refresh_token;d(i,"Unable to refresh. No refresh_token found.");let n=this.state.tokenUri;d(n,"Unable to refresh. No tokenUri found.");let s=this.getState("tokenResponse.scope")||"",o=s.search(/\boffline_access\b/)>-1,l=s.search(/\bonline_access\b/)>-1;if(d(o||l,"Unable to refresh. No offline_access or online_access scope found."),!this._refreshTask){let f=`grant_type=refresh_token&refresh_token=${encodeURIComponent(i)}`;this.environment.options.refreshTokenWithClientId&&(f+=`&client_id=${this.state.clientId}`);let u={credentials:this.environment.options.refreshTokenWithCredentials||"same-origin",...e,method:"POST",mode:"cors",headers:{...e.headers||{},"content-type":"application/x-www-form-urlencoded"},body:f};if(!("authorization"in u.headers)){let{clientSecret:a,clientId:c}=this.state;a&&(u.headers.authorization="Basic "+this.environment.btoa(c+":"+a))}this._refreshTask=_(n,u).then(a=>(d(a.access_token,"No access token received"),r("Received new access token response %O",a),this.state.tokenResponse={...this.state.tokenResponse,...a},this.state.expiresAt=le(a,this.environment),this.state)).catch(a=>{throw this.state?.tokenResponse?.refresh_token&&(r("Deleting the expired or invalid refresh token."),delete this.state.tokenResponse.refresh_token),a}).finally(()=>{this._refreshTask=null;let a=this.state.key;a?this.environment.getStorage().set(a,this.state):r("No 'key' found in Clint.state. Cannot persist the instance.")})}return this._refreshTask}byCode(e,r){return Re(e,r)}byCodes(e,r){return He(e,r)}units=Be;getPath(e,r=""){return k(e,r)}getState(e=""){return k({...this.state},e)}};var C=S.extend("oauth2");function W(){return typeof window=="object"}async function Ut(t="/",e){let r=String(t).replace(/\/*$/,"/")+".well-known/smart-configuration";return ye(r,e).catch(i=>{throw new Error(`Failed to fetch the well-known json "${r}". ${i.message}`)})}async function It(t="/",e){return Ut(t,e).then(r=>{if(!r.authorization_endpoint||!r.token_endpoint)throw new Error("Invalid wellKnownJson");return{registrationUri:r.registration_endpoint||"",authorizeUri:r.authorization_endpoint,tokenUri:r.token_endpoint,codeChallengeMethods:r.code_challenge_methods_supported||[]}})}async function vt(t="/",e){return K(t,e).then(r=>{let i="http://fhir-registry.smarthealthit.org/StructureDefinition/oauth-uris",n=(k(r||{},"rest.0.security.extension")||[]).filter(o=>o.url===i).map(o=>o.extension)[0],s={registrationUri:"",authorizeUri:"",tokenUri:"",codeChallengeMethods:[]};return n&&n.forEach(o=>{o.url==="register"&&(s.registrationUri=o.valueUri),o.url==="authorize"&&(s.authorizeUri=o.valueUri),o.url==="token"&&(s.tokenUri=o.valueUri)}),s})}async function Tt(t="/",e,r){return It(t,e).catch(()=>vt(t,r))}async function fe(t,e={}){let r=t.getUrl();if(Array.isArray(e)){let R=r.searchParams.get("iss")||r.searchParams.get("fhirServiceUrl");if(!R)throw new Error('Passing in an "iss" url parameter is required if authorize uses multiple configurations');let q=e.find(z=>{if(z.issMatch){if(typeof z.issMatch=="function")return!!z.issMatch(R);if(typeof z.issMatch=="string")return z.issMatch===R;if(z.issMatch instanceof RegExp)return z.issMatch.test(R)}return!1});return d(q,`No configuration found matching the current "iss" parameter "${R}"`),await fe(t,q)}let{clientSecret:i,fakeTokenResponse:n,encounterId:s,target:o,width:l,height:f,pkceMode:u,clientPublicKeySetUrl:a,redirect_uri:c,client_id:g}=e,{iss:h,launch:p,patientId:m,fhirServiceUrl:w,redirectUri:y,noRedirect:O,scope:D="",clientId:U,completeInTarget:Y,clientPrivateJwk:Z,stateKey:F}=e,T=t.getStorage();h=r.searchParams.get("iss")||h,w=r.searchParams.get("fhirServiceUrl")||w,p=r.searchParams.get("launch")||p,m=r.searchParams.get("patientId")||m,U=r.searchParams.get("clientId")||U,U||(U=g),y||(y=c),y?y.match(/^https?\:\/\//)||(y=t.relative(y)):y=t.relative(".");let L=String(h||w||"");if(!L)throw new Error("No server url found. It must be specified as `iss` or as `fhirServiceUrl` parameter");if(h&&C("Making %s launch...",p?"EHR":"standalone"),p&&!D.match(/launch/)&&(D+=" launch"),W()){let R=$e(),q=Je();(R||q)&&Y!==!0&&Y!==!1&&(Y=R,console.warn('Your app is being authorized from within an iframe or popup window. Please be explicit and provide a "completeInTarget" option. Use "true" to complete the authorization in the same window, or "false" to try to complete it in the parent or the opener window. See http://docs.smarthealthit.org/client-js/api.html'))}let Se=await T.get(E);await T.unset(Se),F=F??Me(16);let P={clientId:U,scope:D,redirectUri:y,serverUrl:L,clientSecret:i,clientPrivateJwk:Z,tokenResponse:{},key:F,completeInTarget:Y,clientPublicKeySetUrl:a};(W()?k(t,"options.fullSessionStorageSupport"):!0)&&await T.set(E,F),n&&Object.assign(P.tokenResponse,n),m&&Object.assign(P.tokenResponse,{patient:m}),s&&Object.assign(P.tokenResponse,{encounter:s});let v=y+"?state="+encodeURIComponent(F);if(w&&!h)return C("Making fake launch..."),await T.set(F,P),O?v:await t.redirect(v);let Fe=await Tt(L,e.wellKnownRequestOptions,e.conformanceRequestOptions);if(Object.assign(P,Fe),await T.set(F,P),!P.authorizeUri)return O?v:await t.redirect(v);let ie=["response_type=code","client_id="+encodeURIComponent(U||""),"scope="+encodeURIComponent(D),"redirect_uri="+encodeURIComponent(y),"aud="+encodeURIComponent(L),"state="+encodeURIComponent(F)];if(p&&ie.push("launch="+encodeURIComponent(p)),Et(Fe.codeChallengeMethods.includes("S256"),u)){let R=await t.security.generatePKCEChallenge();Object.assign(P,R),await T.set(F,P),ie.push("code_challenge="+P.codeChallenge),ie.push("code_challenge_method=S256")}if(v=P.authorizeUri+"?"+ie.join("&"),O)return v;if(o&&W()){let R;if(R=await De(o,l,f),R!==self)try{R.sessionStorage.removeItem(Se),R.sessionStorage.setItem(F,JSON.stringify(P))}catch(q){S('Failed to modify window.sessionStorage. Perhaps it is from different origin?. Failing back to "_self". %s',q),R=self}if(R!==self)try{R.location.href=v,self.addEventListener("message",Ne)}catch(q){S('Failed to modify window.location. Perhaps it is from different origin?. Failing back to "_self". %s',q),self.location.href=v}else self.location.href=v;return}else return await t.redirect(v)}function Et(t,e){if(e==="disabled")return!1;if(e==="unsafeV1")return!0;if(e==="required"){if(!t)throw new Error("Required PKCE code challenge method (`S256`) was not found in the server's codeChallengeMethods declaration.");return!0}return t}function $e(){try{return self!==top&&parent!==self}catch{return!0}}function Je(){try{return self===top&&!!opener&&opener!==self&&!!window.name}catch{return!1}}function Ne(t){t.data.type=="completeAuth"&&t.origin===new URL(self.location.href).origin&&(window.removeEventListener("message",Ne),window.location.href=t.data.url)}async function be(t,e={}){let r=t.getUrl(),i=t.getStorage(),n=r.searchParams,s=n.get("state")||e.stateKey,o=n.get("code")||e.code,l=n.get("error"),f=n.get("error_description");if(s||(s=await i.get(E)),l||f)throw new Error([l,f].filter(Boolean).join(": "));C("key: %s, code: %s",s,o),d(s,"No 'state' parameter found. Please (re)launch the app.");let u=await i.get(s),a=W()?k(t,"options.fullSessionStorageSupport"):!0;if(W()&&u&&!u.completeInTarget){let p=$e(),m=Je();if((p||m)&&!r.searchParams.get("complete")){r.searchParams.set("complete","1");let{href:w,origin:y}=r;return p&&parent.postMessage({type:"completeAuth",url:w},y),m&&(opener.postMessage({type:"completeAuth",url:w},y),window.close()),new Promise(()=>{})}}r.searchParams.delete("complete");let c=!!(n.has("state")||e.stateKey);if(W()&&k(t,"options.replaceBrowserHistory")&&(o||c)&&(o&&(n.delete("code"),C("Removed code parameter from the url.")),c&&a&&(n.delete("state"),C("Removed state parameter from the url.")),window.history.replaceState&&window.history.replaceState({},"",r.href)),d(u,"No state found! Please (re)launch the app."),!(!o||u.tokenResponse?.access_token)&&u.tokenUri){d(o,"'code' url parameter is required"),C("Preparing to exchange the code for access token...");let p=await _t(t,{code:o,state:u,clientPublicKeySetUrl:e.clientPublicKeySetUrl,privateKey:e.privateKey||u.clientPrivateJwk});C("Token request options: %O",p);let m=await _(u.tokenUri,p);C("Token response: %O",m),d(m.access_token,"Failed to obtain access token."),u.expiresAt=le(m,t),u={...u,tokenResponse:m},await i.set(s,u),C("Authorization successful!")}else C(u.tokenResponse?.access_token?"Already authorized":"No authorization needed");a&&await i.set(E,s);let h=new M(t,u);return C("Created client instance: %O",h),h}async function _t(t,{code:e,state:r,clientPublicKeySetUrl:i,privateKey:n}){let{redirectUri:s,clientSecret:o,tokenUri:l,clientId:f,codeVerifier:u}=r;d(s,"Missing state.redirectUri"),d(l,"Missing state.tokenUri"),d(f,"Missing state.clientId");let a={method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:`code=${e}&grant_type=authorization_code&redirect_uri=${encodeURIComponent(s)}`};if(o)a.headers.authorization="Basic "+t.btoa(f+":"+o),C("Using state.clientSecret to construct the authorization header: %s",a.headers.authorization);else if(n){let c="key"in n?n.key:await t.security.importJWK(n),g={typ:"JWT",kid:n.kid,jku:i||r.clientPublicKeySetUrl},h={iss:f,sub:f,aud:l,jti:t.base64urlencode(t.security.randomBytes(32)),exp:ze(120)},p=await t.security.signCompactJws(n.alg,c,g,h);a.body+=`&client_assertion_type=${encodeURIComponent("urn:ietf:params:oauth:client-assertion-type:jwt-bearer")}`,a.body+=`&client_assertion=${encodeURIComponent(p)}`,C("Using state.clientPrivateJwk to add a client_assertion to the POST body")}else C("Public client detected; adding state.clientId to the POST body"),a.body+=`&client_id=${encodeURIComponent(f)}`;return u&&(C("Found state.codeVerifier, adding to the POST body"),a.body+="&code_verifier="+u),a}async function Ke(t,e,r){let i=t.getUrl(),n=i.searchParams.get("code"),s=i.searchParams.get("state");if(n&&s)return be(t,r);let o=t.getStorage(),l=s||await o.get(E),f=await o.get(l);return f?new M(t,f):fe(t,e).then(()=>new Promise(()=>{}))}var ee=class{async get(e){let r=sessionStorage[e];return r?JSON.parse(r):null}async set(e,r){return sessionStorage[e]=JSON.stringify(r),r}async unset(e){return e in sessionStorage?(delete sessionStorage[e],!0):!1}};var de={};Pe(de,{digestSha256:()=>it,generatePKCEChallenge:()=>Gt,importJWK:()=>Yt,randomBytes:()=>nt,signCompactJws:()=>Zt});var V=typeof Buffer=="function",We=typeof TextDecoder=="function"?new TextDecoder:void 0,Ve=typeof TextEncoder=="function"?new TextEncoder:void 0,Ot="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",te=Array.prototype.slice.call(Ot),he=(t=>{let e={};return t.forEach((r,i)=>e[r]=i),e})(te),qt=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,b=String.fromCharCode.bind(String),Ge=typeof Uint8Array.from=="function"?Uint8Array.from.bind(Uint8Array):t=>new Uint8Array(Array.prototype.slice.call(t,0)),Ze=t=>t.replace(/=/g,"").replace(/[+\/]/g,e=>e=="+"?"-":"_"),Qe=t=>t.replace(/[^A-Za-z0-9\+\/]/g,""),Bt=t=>{let e,r,i,n,s="",o=t.length%3;for(let l=0;l<t.length;){if((r=t.charCodeAt(l++))>255||(i=t.charCodeAt(l++))>255||(n=t.charCodeAt(l++))>255)throw new TypeError("invalid character found");e=r<<16|i<<8|n,s+=te[e>>18&63]+te[e>>12&63]+te[e>>6&63]+te[e&63]}return o?s.slice(0,o-3)+"===".substring(o):s},Xe=typeof btoa=="function"?t=>btoa(t):V?t=>Buffer.from(t,"binary").toString("base64"):Bt,Ce=V?t=>Buffer.from(t).toString("base64"):t=>{let r=[];for(let i=0,n=t.length;i<n;i+=4096)r.push(b.apply(null,t.subarray(i,i+4096)));return Xe(r.join(""))},G=(t,e=!1)=>e?Ze(Ce(t)):Ce(t),Mt=t=>{if(t.length<2){var e=t.charCodeAt(0);return e<128?t:e<2048?b(192|e>>>6)+b(128|e&63):b(224|e>>>12&15)+b(128|e>>>6&63)+b(128|e&63)}else{var e=65536+(t.charCodeAt(0)-55296)*1024+(t.charCodeAt(1)-56320);return b(240|e>>>18&7)+b(128|e>>>12&63)+b(128|e>>>6&63)+b(128|e&63)}},zt=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,Ht=t=>t.replace(zt,Mt),Ye=V?t=>Buffer.from(t,"utf8").toString("base64"):Ve?t=>Ce(Ve.encode(t)):t=>Xe(Ht(t)),jt=(t,e=!1)=>e?Ze(Ye(t)):Ye(t),re=t=>jt(t,!0),Dt=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,Lt=t=>{switch(t.length){case 4:var e=(7&t.charCodeAt(0))<<18|(63&t.charCodeAt(1))<<12|(63&t.charCodeAt(2))<<6|63&t.charCodeAt(3),r=e-65536;return b((r>>>10)+55296)+b((r&1023)+56320);case 3:return b((15&t.charCodeAt(0))<<12|(63&t.charCodeAt(1))<<6|63&t.charCodeAt(2));default:return b((31&t.charCodeAt(0))<<6|63&t.charCodeAt(1))}},$t=t=>t.replace(Dt,Lt),Jt=t=>{if(t=t.replace(/\s+/g,""),!qt.test(t))throw new TypeError("malformed base64.");t+="==".slice(2-(t.length&3));let e,r,i,n=[];for(let s=0;s<t.length;)e=he[t.charAt(s++)]<<18|he[t.charAt(s++)]<<12|(r=he[t.charAt(s++)])<<6|(i=he[t.charAt(s++)]),r===64?n.push(b(e>>16&255)):i===64?n.push(b(e>>16&255,e>>8&255)):n.push(b(e>>16&255,e>>8&255,e&255));return n.join("")},et=typeof atob=="function"?t=>atob(Qe(t)):V?t=>Buffer.from(t,"base64").toString("binary"):Jt,Nt=V?t=>Ge(Buffer.from(t,"base64")):t=>Ge(et(t).split("").map(e=>e.charCodeAt(0)));var Kt=V?t=>Buffer.from(t,"base64").toString("utf8"):We?t=>We.decode(Nt(t)):t=>$t(et(t)),Wt=t=>Qe(t.replace(/[-_]/g,e=>e=="-"?"+":"/")),tt=t=>Kt(Wt(t));if(!globalThis?.crypto?.subtle)throw globalThis.isSecureContext?new Error("Some of the required subtle crypto functionality is not available in the current environment (no crypto.subtle). Please use a polyfill to provide this functionality."):new Error("Some of the required subtle crypto functionality is not available unless you run this app in secure context (using HTTPS or running locally). See https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts");var rt=globalThis.crypto,xe=rt.subtle,Vt={ES384:{name:"ECDSA",namedCurve:"P-384"},RS384:{name:"RSASSA-PKCS1-v1_5",modulusLength:4096,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-384"}}};function nt(t){return rt.getRandomValues(new Uint8Array(t))}async function it(t){let e=new TextEncoder().encode(t),r=await xe.digest("SHA-256",e);return new Uint8Array(r)}var Gt=async(t=96)=>{let e=nt(t),r=G(e,!0);return{codeChallenge:G(await it(r),!0),codeVerifier:r}};async function Yt(t){if(!t.alg)throw new Error('The "alg" property of the JWK must be set to "ES384" or "RS384"');if(Array.isArray(t.key_ops)||(t.key_ops=["sign"]),!t.key_ops.includes("sign"))throw new Error('The "key_ops" property of the JWK does not contain "sign"');try{return await xe.importKey("jwk",t,Vt[t.alg],t.ext===!0,t.key_ops)}catch(e){throw new Error(`The ${t.alg} is not supported by this browser: ${e}`)}}async function Zt(t,e,r,i){let n=JSON.stringify({...r,alg:t}),s=JSON.stringify(i),o=`${re(n)}.${re(s)}`,l=await xe.sign({...e.algorithm,hash:"SHA-384"},e,new TextEncoder().encode(o));return`${o}.${G(new Uint8Array(l),!0)}`}var ne=class{_url=null;_storage=null;options;security=de;constructor(e={}){this.options={replaceBrowserHistory:!0,fullSessionStorageSupport:!0,refreshTokenWithCredentials:"same-origin",...e}}relative(e){return new URL(e,this.getUrl().href).href}get fhir(){return typeof fhir=="function"?fhir:null}getUrl(){return this._url||(this._url=new URL(location+"")),this._url}redirect(e){location.href=e}getStorage(){return this._storage||(this._storage=new ee),this._storage}atob(e){return window.atob(e)}btoa(e){return window.btoa(e)}base64urlencode(e){return typeof e=="string"?re(e):G(e,!0)}base64urldecode(e){return tt(e)}getSmartApi(){return{ready:(...e)=>be(this,...e),authorize:e=>fe(this,e),init:e=>Ke(this,e),client:e=>new M(this,e),options:this.options,utils:{security:de}}}};var Qt=new ne,{ready:Xt,authorize:er,init:tr,client:rr,options:nr,utils:ir}=Qt.getSmartApi(),sr={client:rr,FhirClient:j,utils:ir,oauth2:{settings:nr,ready:Xt,authorize:er,init:tr}},or=sr;return ft(ar);})();
;window.FHIR = FHIR.default;})();
//# sourceMappingURL=fhir-client.min.js.map
